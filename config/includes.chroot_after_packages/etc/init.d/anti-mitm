#!/sbin/openrc-run

command="/usr/bin/python3"
command_args="/opt/anti-mitm.py"
pidfile="/run/anti-mitm.pid"
screen_session="anti-mitm"

depend() {
    after localmount
}

start() {
    ebegin "Starting anti-mitm service"
    
    if pidof -o %PPID -x "$command $command_args" > /dev/null; then
        eend 0 "Service is already running"
        return 0
    fi

    /usr/bin/screen -dmS "$screen_session" "$command" "$command_args"
    
    echo $! > "$pidfile"
    
    eend $? "Anti-mitm service started"
}

stop() {
    ebegin "Stopping anti-mitm service"
    
    if screen -list | grep -q "$screen_session"; then
        screen -S "$screen_session" -X quit
        rm -f "$pidfile" 
        eend 0 "Service stopped"
    else
        eend 0 "Service is not running"
    fi
}
